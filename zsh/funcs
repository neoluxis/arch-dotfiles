# 配置命令免密
nopass() {
    local sudoer_dir="/etc/sudoers.d"

    if [ -z "$1" ]; then
        # 所有命令免密
        local sudoer_file="$sudoer_dir/nopass-all"
        echo "$USER ALL=(ALL) NOPASSWD: ALL" | sudo tee "$sudoer_file" >/dev/null \
            && echo "已为 $USER 设置所有命令免密 sudo"
        return 0
    fi

    local cmd_path
    cmd_path=$(command -v "$1" 2>/dev/null)

    if [ -z "$cmd_path" ]; then
        echo "错误: 找不到命令 $1"
        return 1
    fi

    local sudoer_file="$sudoer_dir/nopass-$1"

    echo "$USER ALL=(ALL) NOPASSWD: $cmd_path" | sudo tee "$sudoer_file" >/dev/null \
        && echo "已为 $1 ($cmd_path) 设置免密 sudo"
}

# 取消命令免密
setpass() {
    local sudoer_dir="/etc/sudoers.d"

    if [ -z "$1" ]; then
        # 取消所有免密
        sudo find "$sudoer_dir" -maxdepth 1 -type f -name 'nopass-*' -delete
        sudo rm -f "$sudoer_dir/nopass-all"

        if [ -n "$(sudo ls "$sudoer_dir" | grep '^nopass-')" ] || sudo test -f "$sudoer_dir/nopass-all"; then
            echo "错误: 部分免密未能删除"
        else
            echo "已取消所有免密 sudo"
        fi
        return 0
    fi

    local sudoer_file="$sudoer_dir/nopass-$1"

    if sudo test -f "$sudoer_file"; then
        sudo rm -f "$sudoer_file" \
            && echo "已取消 $1 的免密 sudo"
    else
        echo "错误: 没有为 $1 设置免密"
        return 1
    fi
}

# 查看免密的命令
listpass() {
    local sudoer_dir="/etc/sudoers.d"
    local files
    files=$(sudo ls "$sudoer_dir" 2>/dev/null | grep '^nopass-' || true)

    if [ -z "$files" ]; then
        echo "当前没有配置免密命令"
        return 0
    fi

    echo "当前免密配置："
    for f in $files; do
        if [ "$f" = "nopass-all" ]; then
            echo "  [ALL] 所有命令免密"
        else
            echo "  ${f#nopass-}"
        fi
    done
}


# 环境初始化工具
nlx_init_ros2() {
    # ROS2 环境初始化，Humble支援
    if [ -f /opt/ros/humble/setup.zsh ]; then
        export ROS_DOMAIN_ID=42
        source /opt/ros/humble/setup.zsh
    else
        echo "No ROS Humble Installation Found!! "
        return 1
    fi
}
nlx_init_conda() {
    # Conda 环境初始化，Anaconda与Miniconda支援
    if [ -f /opt/anaconda/bin/conda ]; then
        export CONDA=anaconda
        export CONDA_PREFIX=/opt/anaconda
    elif [ -f /opt/miniconda3/bin/conda ]; then
        export CONDA=miniconda
        export CONDA_PREFIX=/opt/miniconda3
    else
        echo "No Conda Installation Found! "
        return 1
    fi

    __conda_setup="$(\"${CONDA_PREFIX}/bin/conda\" 'shell.zsh' 'hook' 2> /dev/null)"
    if [ $? -eq 0 ]; then
        eval "$__conda_setup"
    else
        if [ -f "${CONDA_PREFIX}/etc/profile.d/conda.sh" ]; then
            . "${CONDA_PREFIX}/etc/profile.d/conda.sh"
        else
            export PATH="${CONDA_PREFIX}/bin:$PATH"
        fi
    fi
    unset __conda_setup

    # 用于防止 SSL 报错，或者可以通过root后更新conda base环境解决
    export CRYPTOGRAPHY_OPENSSL_NO_LEGACY=1
}
nlx_init_oneapi() {
    # Intel Oneapi 环境初始化
    if [ -f /opt/intel/oneapi/setvars.sh ]; then
        LOGFILE="/tmp/intel-oneapi-init-$(whoami)-$(date '+%Y-%m-%d_%H-%M-%S').log"
        source /opt/intel/oneapi/setvars.sh > "$LOGFILE" 2>&1
    fi
}
nlx_init_pyenv() {
    export PYENV_ROOT="$HOME/.pyenv"
    [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init - zsh)"
}

initer() {
	if [ "$1" = "ros2" ]; then
		nlx_init_ros2
	elif [ "$1" = "conda" ]; then
        nlx_init_conda
	elif [ "$1" = "pyenv" ]; then
        nlx_init_pyenv
	elif [ "$1" = "oneapi" ]; then
        nlx_init_oneapi
	else
		echo "Usage: initer <ros2|conda|oneapi> [-h]"
	fi
}

